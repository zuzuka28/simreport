ARG GO_VERSION=1.23

FROM golang:${GO_VERSION} AS build

ARG SERVICE_NAME

RUN apt update && apt install -y git  ca-certificates && update-ca-certificates

RUN test -n "$SERVICE_NAME" || (echo "SERVICE_NAME not set" && false)

WORKDIR /app

COPY ./prj/${SERVICE_NAME}  .

RUN export CGO_ENABLED=0 && \
    go test ./... && \
    go build -installsuffix 'static' -o app ./cmd/${SERVICE_NAME}

FROM gcr.io/distroless/static AS final

COPY --from=build app app
